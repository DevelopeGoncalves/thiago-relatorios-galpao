<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Gest√£o de Obras</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --background-color: #f4f7f9;
            --card-background: #ffffff;
            --text-color: #333;
            --success-color: #4CAF50;
            --danger-color: #F44336;
            --warning-color: #FFC107;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar/Menu */
        .sidebar {
            width: 250px;
            background: var(--primary-color);
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            height: 100vh;
        }

        .logo {
            text-align: center;
            padding: 10px 0 30px 0;
            font-size: 1.5em;
            font-weight: 700;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 20px;
        }

        .menu {
            list-style: none;
            padding: 0;
        }

        .menu li {
            margin: 5px 0;
        }

        .menu a, .tab {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.1s;
            cursor: pointer;
            border-left: 5px solid transparent;
        }

        .menu a:hover, .tab:hover {
            background-color: var(--secondary-color);
        }

        .menu .tab.active {
            background-color: var(--secondary-color);
            border-left-color: white;
            font-weight: 600;
        }

        .menu i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        /* Main Content */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--background-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .header h1 {
            margin: 0;
            font-size: 2em;
            color: var(--primary-color);
        }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
            border-left: 5px solid var(--primary-color);
        }

        .card.danger { border-left-color: var(--danger-color); }
        .card.success { border-left-color: var(--success-color); }
        .card.warning { border-left-color: var(--warning-color); }


        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 5px;
        }

        .card-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Tabs Content */
        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        /* Data Table Styling */
        .data-table {
            background: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background-color: #f7f9fc;
            color: var(--primary-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        .data-table tbody tr:hover {
            background-color: #f0f2f5;
        }

        .data-table tfoot td {
            font-weight: 700;
            background-color: #eef1f5;
            color: var(--secondary-color);
            border-top: 2px solid var(--primary-color);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .status-vencido, .status-baixo { background-color: var(--danger-color); }
        .status-proximo { background-color: var(--warning-color); }
        .status-pago, .status-ok { background-color: var(--success-color); }

        /* Forms and Buttons */
        .form-container, .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-container input:not([type="checkbox"]):not([type="radio"]), .form-container select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex: 1;
            min-width: 150px;
            font-family: inherit;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }

        .btn-action {
            padding: 5px 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        /* Gr√°ficos */
        .chart-container {
            background: var(--card-background);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        /* Relat√≥rios */
        .relatorio-filters {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            margin-bottom: 30px;
            padding: 15px;
            background-color: #eef1f5;
            border-radius: 8px;
        }

        .relatorio-filters div {
            display: flex;
            flex-direction: column;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
        }

        .checkbox-group label {
            font-size: 0.9em;
            font-weight: 500;
        }

        .print-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            font-size: 1.1em;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none;
        }

        /* Print Styles */
        @media print {
            body { 
                background-color: white; 
                display: block;
            }
            .sidebar, .header, .relatorio-filters, .print-button {
                display: none;
            }
            .main-content {
                padding: 0;
            }
            .tab-content.active {
                display: block;
            }
            .data-table {
                box-shadow: none;
                padding: 0;
            }
            .data-table table {
                border: 1px solid #ccc;
            }
            .data-table th, .data-table td {
                border: 1px solid #ccc;
            }
            .data-table tfoot td {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact;
                border-top: 1px solid #ccc;
            }
            .status-badge {
                color: #333 !important;
                background: none !important;
            }
            h1, h2, h3 { color: var(--text-color) !important; -webkit-print-color-adjust: exact; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

    <div class="sidebar">
        <div class="logo">üöß Gest√£o de Obras</div>
        <ul class="menu">
            <li><div class="tab active" onclick="mudarAba('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</div></li>
            <li><div class="tab" onclick="mudarAba('gastos')"><i class="fas fa-money-bill-wave"></i> Gastos Di√°rios</div></li>
            <li><div class="tab" onclick="mudarAba('boletos')"><i class="fas fa-receipt"></i> Controle de Boletos</div></li>
            <li><div class="tab" onclick="mudarAba('estoque')"><i class="fas fa-hard-hat"></i> Estoque EPI</div></li>
            <li><div class="tab" onclick="mudarAba('materiais')"><i class="fas fa-boxes"></i> Compra de Materiais</div></li>
            <li><div class="tab" onclick="mudarAba('graficos')"><i class="fas fa-chart-bar"></i> An√°lise Gr√°fica</div></li>
            <li><div class="tab" onclick="mudarAba('relatorios')"><i class="fas fa-file-alt"></i> Gerar Relat√≥rios</div></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="header">
            <h1 id="currentTitle">Dashboard Principal</h1>
            <button class="btn btn-primary" onclick="carregarDados()"><i class="fas fa-sync-alt"></i> Atualizar Dados</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="cards-grid">
                <div class="card warning">
                    <div class="card-title">üí∏ Gastos Hoje</div>
                    <div class="card-value" id="gastosHoje">R$ 0,00</div>
                </div>
                <div class="card warning">
                    <div class="card-title">üìä Gastos M√™s</div>
                    <div class="card-value" id="gastosMes">R$ 0,00</div>
                </div>
                <div class="card danger">
                    <div class="card-title">üö® Boletos Vencidos</div>
                    <div class="card-value" id="boletosVencidos">0</div>
                </div>
                <div class="card success">
                    <div class="card-title">üë∑ EPIs em Estoque</div>
                    <div class="card-value" id="episEstoque">0</div>
                </div>
            </div>

            <div class="data-table">
                <h2>Pr√≥ximos Vencimentos</h2>
                <div id="proximosVencimentos">
                    </div>
            </div>
        </div>

        <div id="gastos" class="tab-content">
            <h2 style="color: var(--secondary-color);">Registro de Gastos</h2>
            <div class="form-container data-table">
                <input type="date" id="gastoData" placeholder="Data" value="" required>
                <input type="text" id="gastoDescricao" placeholder="Descri√ß√£o do Gasto" required>
                <select id="gastoCategoria" required>
                    <option value="">Selecione a Categoria</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                    <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                    <option value="Escrit√≥rio">Escrit√≥rio</option>
                    <option value="Escrit√≥rio">Combustivel</option>
                    <option value="Outros">Outros</option>
                </select>
                <input type="number" id="gastoValor" placeholder="Valor (R$)" step="0.01" required>
                <button class="btn btn-primary" onclick="adicionarGasto()"><i class="fas fa-plus"></i> Adicionar Gasto</button>
            </div>
            
            <div class="data-table">
                <h2>Hist√≥rico Detalhado</h2>
                <div id="tabelaGastos"></div>
            </div>
        </div>

        <div id="boletos" class="tab-content">
            <h2 style="color: var(--secondary-color);">Lan√ßamento de Boletos</h2>
            <div class="form-container data-table">
                <input type="text" id="boletoDescricao" placeholder="Descri√ß√£o do Boleto" required>
                <input type="number" id="boletoValor" placeholder="Valor (R$)" step="0.01" required>
                <input type="date" id="boletoVencimento" placeholder="Data de Vencimento" required>
                <button class="btn btn-primary" onclick="adicionarBoleto()"><i class="fas fa-plus"></i> Adicionar Boleto</button>
            </div>

            <div class="data-table">
                <h2>Boletos Pendentes e Pagos</h2>
                <div id="tabelaBoletos"></div>
            </div>
        </div>

        <div id="estoque" class="tab-content">
            <h2 style="color: var(--secondary-color);">Gerenciamento de EPIs</h2>
            <div class="form-container data-table">
                <input type="text" id="epiItem" placeholder="Nome do EPI" required>
                <select id="epiCategoria" required>
                    <option value="">Selecione a Categoria</option>
                    <option value="Prote√ß√£o">Prote√ß√£o</option>
                    <option value="Uniforme">Uniforme</option>
                    <option value="Ferramenta">Ferramenta</option>
                </select>
                <input type="number" id="epiQuantidade" placeholder="Quantidade Inicial" required>
                <input type="number" id="epiMinimo" placeholder="Estoque M√≠nimo" required>
                <button class="btn btn-primary" onclick="adicionarEPI()"><i class="fas fa-plus"></i> Novo EPI</button>
            </div>

            <div class="data-table">
                <h2>Estoque Atual e Movimenta√ß√£o</h2>
                <div id="tabelaEstoque"></div>
            </div>
        </div>

        <div id="materiais" class="tab-content">
            <h2 style="color: var(--secondary-color);">Registro de Compra de Materiais</h2>
            <div class="form-container data-table">
                <input type="date" id="materialData" placeholder="Data da Compra" required>
                <input type="text" id="materialItem" placeholder="Item Comprado (Ex: Cimento, Areia)" required>
                <input type="number" id="materialQuantidade" placeholder="Quantidade" required>
                <input type="number" id="materialValor" placeholder="Valor Total (R$)" step="0.01" required>
                <input type="text" id="materialFornecedor" placeholder="Fornecedor" required>
                <button class="btn btn-primary" onclick="adicionarMaterial()"><i class="fas fa-plus"></i> Registrar Compra</button>
            </div>

            <div class="data-table">
                <h2>Hist√≥rico de Compras</h2>
                <div id="tabelaMateriais"></div>
            </div>
        </div>

        <div id="graficos" class="tab-content">
            <h2 style="color: var(--secondary-color);">Visualiza√ß√£o de Dados</h2>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <h3>Gastos por Categoria (M√™s Atual)</h3>
                    <canvas id="gastosPorCategoriaChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Itens de Estoque por Status</h3>
                    <canvas id="estoqueStatusChart"></canvas>
                </div>
            </div>

            <div class="chart-grid" style="margin-top: 20px;">
                <div class="chart-container">
                    <h3>Total de Compras de Materiais (√öltimos 6 meses)</h3>
                    <canvas id="materiaisPorMesChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Gastos Di√°rios (√öltimos 30 dias)</h3>
                    <canvas id="gastosDiariosChart"></canvas>
                </div>
            </div>
        </div>

        <div id="relatorios" class="tab-content">
            <h2 style="color: var(--secondary-color);">Personalizar Relat√≥rio</h2>
            
            <div class="relatorio-filters">
                <div>
                    <label>Data Inicial:</label>
                    <input type="date" id="relatorioDataInicio" required>
                </div>
                <div>
                    <label>Data Final:</label>
                    <input type="date" id="relatorioDataFim" required>
                </div>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="checkResumo" checked> Resumo Financeiro</label>
                    <label><input type="checkbox" id="checkGastos" checked> Gastos Di√°rios</label>
                    <label><input type="checkbox" id="checkBoletos" checked> Controle de Boletos</label>
                    <label><input type="checkbox" id="checkEstoque" checked> Estoque de EPIs</label>
                    <label><input type="checkbox" id="checkMateriais" checked> Compra de Materiais</label>
                </div>
                <button class="btn btn-primary" onclick="gerarRelatorio()"><i class="fas fa-file-export"></i> Gerar Relat√≥rio</button>
            </div>
            
            <div id="relatorioOutput" class="data-table" style="display: none;">
                </div>
        </div>
    </div>
    
    <button class="btn btn-success print-button" onclick="window.print()">
        <i class="fas fa-print"></i> Imprimir Relat√≥rio
    </button>

    <script>
        // URL da API WEB do Google Apps Script - SUBSTITUA ESTA URL PELA SUA!
        const webAppUrl = "https://script.google.com/macros/s/AKfycbzirLFf7ExY9FWqDymC2AD40Okyz9tNatz_lnZPOzU8UM69od8lpDHcOStp2OIvULy7/exec";

        let dados = {
            gastos: [],
            boletos: [],
            estoque: [],
            materiais: []
        };

        let chartInstances = {};

        function carregarDadosExemplo() {
            // Dados de Exemplo (Usados em caso de falha na API)
            const hoje = new Date().toISOString().split('T')[0];
            const dataProximo = new Date();
            dataProximo.setDate(dataProximo.getDate() + 3);
            const dataProximoStr = dataProximo.toISOString().split('T')[0];
            const dataVencido = new Date();
            dataVencido.setDate(dataVencido.getDate() - 5);
            const dataVencidoStr = dataVencido.toISOString().split('T')[0];
            
            dados = {
                gastos: [
                    { data: hoje, descricao: 'Combust√≠vel', valor: 250.00, categoria: 'Transporte' },
                    { data: hoje, descricao: 'Almo√ßo equipe', valor: 120.00, categoria: 'Alimenta√ß√£o' },
                    { data: '2025-11-22', descricao: 'Material escrit√≥rio', valor: 85.50, categoria: 'Escrit√≥rio' },
                    { data: '2025-11-20', descricao: 'Ped√°gio', valor: 40.00, categoria: 'Transporte' },
                    { data: '2025-11-18', descricao: 'Reparo m√°quina', valor: 550.00, categoria: 'Manuten√ß√£o' },
                    { data: '2025-11-15', descricao: 'Caf√© da manh√£', valor: 50.00, categoria: 'Alimenta√ß√£o' }
                ],
                boletos: [
                    { id: 1, descricao: 'Energia El√©trica', valor: 450.00, vencimento: dataProximoStr, status: 'Pendente', dataPagamento: '', meioPagamento: '' },
                    { id: 2, descricao: '√Ågua', valor: 120.00, vencimento: dataVencidoStr, status: 'Pendente', dataPagamento: '', meioPagamento: '' },
                    { id: 3, descricao: 'Internet', valor: 199.90, vencimento: '2025-12-05', status: 'Pendente', dataPagamento: '', meioPagamento: '' },
                    { id: 4, descricao: 'Aluguel', valor: 2500.00, vencimento: '2025-10-01', status: 'Pago', dataPagamento: '2025-09-30', meioPagamento: 'Pix Santander' }
                ],
                estoque: [
                    { id: 1, item: 'Capacete', quantidade: 45, minimo: 20, categoria: 'Prote√ß√£o', dataUltimaEntrada: '2025-11-01', dataUltimaSaida: '2025-11-20' },
                    { id: 2, item: 'Luva', quantidade: 120, minimo: 50, categoria: 'Prote√ß√£o', dataUltimaEntrada: '2025-11-10', dataUltimaSaida: hoje },
                    { id: 3, item: '√ìculos de Prote√ß√£o', quantidade: 15, minimo: 30, categoria: 'Prote√ß√£o', dataUltimaEntrada: '2025-10-25', dataUltimaSaida: '2025-11-22' }
                ],
                materiais: [
                    { data: '2025-11-20', item: 'Cimento', quantidade: 50, valor: 1500.00, fornecedor: 'Constrular' },
                    { data: '2025-11-18', item: 'Areia', quantidade: 100, valor: 800.00, fornecedor: 'Arei√£o' }
                ]
            };
            
            dados.boletos.forEach((b, i) => b.id = b.id || (i + 1));
            dados.estoque.forEach((e, i) => e.id = e.id || (i + 1));

            atualizarDashboard();
        }

        function carregarDados() {
            if (!webAppUrl || webAppUrl.includes("AKfycbyGYfUdoyPExuRrnTds6ZbwLNpc13K8bsgPh4K-ME2zWUmomC8j45TjvwnRsGKRF_pM")) {
                alert('A URL da API Web do Google Apps Script n√£o est√° configurada ou √© a URL de exemplo! Carregando dados de exemplo.');
                return carregarDadosExemplo(); 
            }

            // Requisi√ß√£o Fetch para buscar os dados na API Web
            fetch(webAppUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro de rede: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert('Erro na API Apps Script: ' + data.error);
                        return;
                    }
                    
                    dados.gastos = data.gastos || [];
                    // Adicionado valores padr√£o para novas propriedades caso n√£o venham da API
                    dados.boletos = (data.boletos || []).map(b => ({
                        ...b,
                        dataPagamento: b.dataPagamento || '',
                        meioPagamento: b.meioPagamento || ''
                    }));
                    dados.estoque = (data.estoque || []).map(e => ({
                        ...e,
                        dataUltimaEntrada: e.dataUltimaEntrada || '',
                        dataUltimaSaida: e.dataUltimaSaida || ''
                    }));
                    dados.materiais = data.materiais || [];

                    alert('Dados atualizados com sucesso do Google Sheets! (Via Apps Script)');
                    atualizarDashboard();
                    
                    const abaAtiva = document.querySelector('.tab-content.active').id;
                    if (abaAtiva === 'graficos') atualizarGraficos();
                    if (abaAtiva === 'relatorios') gerarRelatorio();
                })
                .catch(error => {
                    console.error('Falha ao carregar dados:', error);
                    alert(`Falha ao conectar com a API Web. Carregando dados de exemplo. Detalhes: ${error.message}.`);
                    carregarDadosExemplo(); 
                });
        }

        function mudarAba(aba) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const target = event ? event.target.closest('.tab') : document.querySelector(`.tab[onclick*="${aba}"]`);
            if (target) target.classList.add('active');
            document.getElementById(aba).classList.add('active');
            
            document.getElementById('currentTitle').textContent = target ? target.textContent.trim() : 'Dashboard Principal';
            document.querySelector('.print-button').style.display = 'none';

            atualizarDashboard();

            if (aba === 'gastos') montarTabelaGastos(dados.gastos, 'tabelaGastos');
            else if (aba === 'boletos') montarTabelaBoletos(dados.boletos, 'tabelaBoletos');
            else if (aba === 'estoque') montarTabelaEstoque(dados.estoque, 'tabelaEstoque');
            else if (aba === 'materiais') montarTabelaMateriais(dados.materiais, 'tabelaMateriais');
            else if (aba === 'graficos') atualizarGraficos();
            else if (aba === 'relatorios') {
                inicializarFiltrosRelatorio();
                document.getElementById('relatorioOutput').style.display = 'none';
            }
        }

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(parseFloat(valor) || 0);
        }

        function formatarData(data) {
            if (!data || data === 'N/A') return 'N/A';
            try {
                const d = new Date(data + 'T00:00:00');
                if (isNaN(d)) return data;
                return d.toLocaleDateString('pt-BR');
            } catch {
                return data;
            }
        }

        function calcularDiasAteVencimento(dataVencimento) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const vencimento = new Date(dataVencimento);
            vencimento.setHours(0, 0, 0, 0);
            const diff = Math.ceil((vencimento.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24));
            return diff;
        }

        function getStatusBoleto(dataVencimento, statusAtual) {
            if (statusAtual === 'Pago') return { classe: 'status-pago', texto: 'Pago' };

            const dias = calcularDiasAteVencimento(dataVencimento);
            if (dias < 0) return { classe: 'status-vencido', texto: 'Vencido' };
            if (dias <= 7) return { classe: 'status-proximo', texto: `${dias} dias` };
            return { classe: 'status-ok', texto: 'Pendente' };
        }

        // --- MODIFICA√á√ÉO BOLETOS: Coletar Meio de Pagamento ---
        function marcarBoletoPago(id) {
            const boleto = dados.boletos.find(b => b.id === id);
            if (boleto) {
                if (boleto.status === 'Pago') {
                    alert('Boleto j√° est√° marcado como Pago.');
                    return;
                }

                const hoje = new Date().toISOString().split('T')[0];
                
                const meio = prompt(`Qual o meio de pagamento para "${boleto.descricao}" (Ex: Pix, D√©bito, Santander)?`);
                
                if (!meio || meio.trim() === '') {
                    alert('Meio de pagamento obrigat√≥rio para registrar o pagamento.');
                    return;
                }

                boleto.status = 'Pago';
                boleto.dataPagamento = hoje;
                boleto.meioPagamento = meio.trim();
                
                alert(`Boleto ${boleto.descricao} marcado como Pago via ${meio.trim()} em ${formatarData(hoje)}! (Simula√ß√£o)`);
                
                atualizarDashboard();
                montarTabelaBoletos(dados.boletos, 'tabelaBoletos');
                atualizarGraficos();
            }
        }

        // --- MODIFICA√á√ÉO ESTOQUE: Registrar Data de Entrada ---
        function entradaEstoque(id) {
            const item = dados.estoque.find(e => e.id === id);
            if (item) {
                const quantidade = parseInt(prompt(`Quantas unidades de ${item.item} est√£o entrando no estoque?`));
                if (isNaN(quantidade) || quantidade <= 0) {
                    alert('Entrada inv√°lida.');
                    return;
                }
                item.quantidade = parseInt(item.quantidade) + quantidade;
                item.dataUltimaEntrada = new Date().toISOString().split('T')[0];
                
                alert(`${quantidade} unidades de ${item.item} adicionadas! Novo total: ${item.quantidade}. (Simula√ß√£o)`);
                
                atualizarDashboard();
                montarTabelaEstoque(dados.estoque, 'tabelaEstoque');
                atualizarGraficos();
            }
        }

        // --- MODIFICA√á√ÉO ESTOQUE: Registrar Data de Sa√≠da ---
        function saidaEstoque(id) {
            const item = dados.estoque.find(e => e.id === id);
            if (item) {
                const quantidade = parseInt(prompt(`Quantas unidades de ${item.item} est√£o saindo do estoque?`));
                if (isNaN(quantidade) || quantidade <= 0) {
                    alert('Sa√≠da inv√°lida.');
                    return;
                }
                if (item.quantidade < quantidade) {
                    alert('Quantidade em estoque insuficiente.');
                    return;
                }
                item.quantidade = parseInt(item.quantidade) - quantidade;
                item.dataUltimaSaida = new Date().toISOString().split('T')[0];
                
                alert(`${quantidade} unidades de ${item.item} removidas! Novo total: ${item.quantidade}. (Simula√ß√£o)`);
                
                atualizarDashboard();
                montarTabelaEstoque(dados.estoque, 'tabelaEstoque');
                atualizarGraficos();
            }
        }

        function atualizarDashboard() {
            // GASTOS
            const hoje = new Date().toISOString().split('T')[0];
            const mesAtual = new Date().getMonth();

            const gastosHoje = dados.gastos
                .filter(g => g.data === hoje)
                .reduce((sum, g) => sum + parseFloat(g.valor), 0);
            document.getElementById('gastosHoje').textContent = formatarMoeda(gastosHoje);

            const gastosMes = dados.gastos
                .filter(g => new Date(g.data + 'T00:00:00').getMonth() === mesAtual)
                .reduce((sum, g) => sum + parseFloat(g.valor), 0);
            document.getElementById('gastosMes').textContent = formatarMoeda(gastosMes);

            // BOLETOS
            const boletosVencidos = dados.boletos.filter(b => b.status !== 'Pago' && calcularDiasAteVencimento(b.vencimento) < 0).length;
            document.getElementById('boletosVencidos').textContent = boletosVencidos;

            const proximosBoletos = dados.boletos
                .filter(b => b.status !== 'Pago')
                .sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento))
                .slice(0, 5);

            let htmlVencimentos = '<table><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Vencimento</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>';
            proximosBoletos.forEach(b => {
                const status = getStatusBoleto(b.vencimento, b.status);
                htmlVencimentos += `
                    <tr>
                        <td>${b.descricao}</td>
                        <td>${formatarMoeda(b.valor)}</td>
                        <td>${formatarData(b.vencimento)}</td>
                        <td><span class="status-badge ${status.classe}">${status.texto}</span></td>
                        <td>${b.status !== 'Pago' ? `<button class="btn-success btn-action" onclick="marcarBoletoPago(${b.id})">Pagar</button>` : ''}</td>
                    </tr>
                `;
            });
            htmlVencimentos += '</tbody></table>';
            document.getElementById('proximosVencimentos').innerHTML = proximosBoletos.length > 0 ? htmlVencimentos : '<p style="text-align: center; color: #888;">Nenhum boleto pendente ou pr√≥ximo do vencimento.</p>';

            // ESTOQUE
            const totalEPIs = dados.estoque.reduce((sum, e) => sum + parseInt(e.quantidade), 0);
            document.getElementById('episEstoque').textContent = totalEPIs;

            // TABELAS
            // Re-renderiza as tabelas se a aba estiver ativa
            const abaAtiva = document.querySelector('.tab-content.active').id;
            if (abaAtiva === 'gastos') montarTabelaGastos(dados.gastos, 'tabelaGastos');
            else if (abaAtiva === 'boletos') montarTabelaBoletos(dados.boletos, 'tabelaBoletos');
            else if (abaAtiva === 'estoque') montarTabelaEstoque(dados.estoque, 'tabelaEstoque');
            else if (abaAtiva === 'materiais') montarTabelaMateriais(dados.materiais, 'tabelaMateriais');
        }

        function montarTabelaGastos(lista, idContainer) {
            let total = 0;
            let html = '<table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th></tr></thead><tbody>';

            lista.sort((a, b) => new Date(b.data) - new Date(a.data));

            lista.forEach(g => {
                total += parseFloat(g.valor);
                html += `
                    <tr>
                        <td>${formatarData(g.data)}</td>
                        <td>${g.descricao}</td>
                        <td>${g.categoria}</td>
                        <td>${formatarMoeda(g.valor)}</td>
                    </tr>
                `;
            });

            html += `</tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">Total Geral</td>
                        <td>${formatarMoeda(total)}</td>
                    </tr>
                </tfoot>
            </table>`;
            document.getElementById(idContainer).innerHTML = html;
        }

        // --- MODIFICA√á√ÉO BOLETOS: Adicionado Data/Meio de Pagamento na Tabela ---
        function montarTabelaBoletos(lista, idContainer) {
            let html = '<table><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Vencimento</th><th>Status</th><th>Data Pag.</th><th>Meio Pag.</th><th>A√ß√µes</th></tr></thead><tbody>';
            let totalPendente = 0;
            
            lista.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));

            lista.forEach(b => {
                const status = getStatusBoleto(b.vencimento, b.status);
                if (b.status !== 'Pago') totalPendente += parseFloat(b.valor);
                
                html += `
                    <tr>
                        <td>${b.descricao}</td>
                        <td>${formatarMoeda(b.valor)}</td>
                        <td>${formatarData(b.vencimento)}</td>
                        <td><span class="status-badge ${status.classe}">${status.texto}</span></td>
                        <td>${b.dataPagamento ? formatarData(b.dataPagamento) : 'N/A'}</td>
                        <td>${b.meioPagamento || 'N/A'}</td>
                        <td>${b.status !== 'Pago' ? `<button class="btn-success btn-action" onclick="marcarBoletoPago(${b.id})">Pagar</button>` : ''}</td>
                    </tr>
                `;
            });

            html += `</tbody>
                <tfoot>
                    <tr>
                        <td colspan="5">Total Pendente (Boletos N√£o Pagos)</td>
                        <td colspan="2">${formatarMoeda(totalPendente)}</td>
                    </tr>
                </tfoot>
            </table>`;
            document.getElementById(idContainer).innerHTML = html;
        }

        // --- MODIFICA√á√ÉO ESTOQUE: Adicionado Data de Entrada/Sa√≠da na Tabela ---
        function montarTabelaEstoque(lista, idContainer) {
            let html = '<table><thead><tr><th>Item</th><th>Categoria</th><th>Quantidade</th><th>M√≠nimo</th><th>Status</th><th>√öltima Entrada</th><th>√öltima Sa√≠da</th><th>A√ß√µes</th></tr></thead><tbody>';
            let itensBaixo = 0;

            lista.forEach(e => {
                const statusClass = parseInt(e.quantidade) < parseInt(e.minimo) ? 'status-baixo' : 'status-ok';
                const statusText = parseInt(e.quantidade) < parseInt(e.minimo) ? 'Baixo' : 'OK';
                if (statusText === 'Baixo') itensBaixo++;
                
                html += `
                    <tr>
                        <td>${e.item}</td>
                        <td>${e.categoria}</td>
                        <td>${e.quantidade}</td>
                        <td>${e.minimo}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${e.dataUltimaEntrada ? formatarData(e.dataUltimaEntrada) : 'N/A'}</td>
                        <td>${e.dataUltimaSaida ? formatarData(e.dataUltimaSaida) : 'N/A'}</td>
                        <td>
                            <button class="btn-success btn-action" onclick="entradaEstoque(${e.id})">‚ûï Entrada</button>
                            <button class="btn-danger btn-action" onclick="saidaEstoque(${e.id})">‚ûñ Sa√≠da</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody>
                <tfoot>
                    <tr>
                        <td colspan="6">Total de Itens Baixo Estoque</td>
                        <td colspan="2">${itensBaixo} item(s)</td>
                    </tr>
                </tfoot>
            </table>`;
            document.getElementById(idContainer).innerHTML = html;
        }

        function montarTabelaMateriais(lista, idContainer) {
            let total = 0;
            let html = '<table><thead><tr><th>Data</th><th>Item</th><th>Quantidade</th><th>Valor Total</th><th>Fornecedor</th></tr></thead><tbody>';

            lista.sort((a, b) => new Date(b.data) - new Date(a.data));

            lista.forEach(m => {
                total += parseFloat(m.valor);
                html += `
                    <tr>
                        <td>${formatarData(m.data)}</td>
                        <td>${m.item}</td>
                        <td>${m.quantidade}</td>
                        <td>${formatarMoeda(m.valor)}</td>
                        <td>${m.fornecedor}</td>
                    </tr>
                `;
            });

            html += `</tbody>
                <tfoot>
                    <tr>
                        <td colspan="3">Total Gasto em Materiais</td>
                        <td colspan="2">${formatarMoeda(total)}</td>
                    </tr>
                </tfoot>
            </table>`;
            document.getElementById(idContainer).innerHTML = html;
        }

        // --- Fun√ß√µes de Gr√°ficos ---
        
        function destruirGrafico(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function atualizarGraficos() {
            // Destruir gr√°ficos existentes antes de criar novos
            destruirGrafico('gastosPorCategoriaChart');
            destruirGrafico('estoqueStatusChart');
            destruirGrafico('materiaisPorMesChart');
            destruirGrafico('gastosDiariosChart');

            // 1. Gastos por Categoria (M√™s Atual)
            const gastosMesAtual = dados.gastos.filter(g => new Date(g.data + 'T00:00:00').getMonth() === new Date().getMonth());
            const gastosAgrupados = gastosMesAtual.reduce((acc, g) => {
                acc[g.categoria] = (acc[g.categoria] || 0) + parseFloat(g.valor);
                return acc;
            }, {});

            const categorias = Object.keys(gastosAgrupados);
            const valores = Object.values(gastosAgrupados);

            const ctx1 = document.getElementById('gastosPorCategoriaChart').getContext('2d');
            chartInstances.gastosPorCategoriaChart = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: categorias,
                    datasets: [{
                        data: valores,
                        backgroundColor: ['#667eea', '#764ba2', '#ffc107', '#4CAF50', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: (item) => formatarMoeda(item.raw) } }
                    }
                }
            });

            // 2. Estoque por Status
            const statusCount = dados.estoque.reduce((acc, e) => {
                const status = parseInt(e.quantidade) < parseInt(e.minimo) ? 'Baixo Estoque' : 'Estoque OK';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            
            const ctx2 = document.getElementById('estoqueStatusChart').getContext('2d');
            chartInstances.estoqueStatusChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCount),
                    datasets: [{
                        data: Object.values(statusCount),
                        backgroundColor: ['#F44336', '#4CAF50']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });

            // 3. Compras de Materiais (√öltimos 6 meses)
            const meses = [];
            const totaisMes = [];
            const hoje = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                const mesLabel = d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' });
                meses.push(mesLabel);

                const total = dados.materiais
                    .filter(m => {
                        const dataMaterial = new Date(m.data + 'T00:00:00');
                        return dataMaterial.getFullYear() === d.getFullYear() && dataMaterial.getMonth() === d.getMonth();
                    })
                    .reduce((sum, m) => sum + parseFloat(m.valor), 0);
                
                totaisMes.push(total);
            }

            const ctx3 = document.getElementById('materiaisPorMesChart').getContext('2d');
            chartInstances.materiaisPorMesChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: meses,
                    datasets: [{
                        label: 'Gasto Total em Materiais',
                        data: totaisMes,
                        backgroundColor: '#667eea',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (value) => formatarMoeda(value) } }
                    },
                    plugins: {
                        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${formatarMoeda(item.raw)}` } }
                    }
                }
            });

            // 4. Gastos Di√°rios (√öltimos 30 dias)
            const gastosDiariosMap = new Map();
            for(let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dataStr = d.toISOString().split('T')[0];
                gastosDiariosMap.set(formatarData(dataStr), 0);
            }
            
            dados.gastos.forEach(g => {
                const dataFormatada = formatarData(g.data);
                if (gastosDiariosMap.has(dataFormatada)) {
                    gastosDiariosMap.set(dataFormatada, gastosDiariosMap.get(dataFormatada) + parseFloat(g.valor));
                }
            });

            const ctx4 = document.getElementById('gastosDiariosChart').getContext('2d');
            chartInstances.gastosDiariosChart = new Chart(ctx4, {
                type: 'line',
                data: {
                    labels: Array.from(gastosDiariosMap.keys()),
                    datasets: [{
                        label: 'Gastos Di√°rios (R$)',
                        data: Array.from(gastosDiariosMap.values()),
                        borderColor: '#F44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: (value) => formatarMoeda(value) } }
                    },
                    plugins: {
                        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${formatarMoeda(item.raw)}` } }
                    }
                }
            });
        }

        // Implementa√ß√£o das fun√ß√µes de Adi√ß√£o (Simula√ß√£o)
        function adicionarGasto() {
            const data = document.getElementById('gastoData').value;
            const descricao = document.getElementById('gastoDescricao').value;
            const categoria = document.getElementById('gastoCategoria').value;
            const valor = parseFloat(document.getElementById('gastoValor').value);

            if (!data || !descricao || !categoria || isNaN(valor) || valor <= 0) {
                alert('Preencha todos os campos corretamente para registrar o gasto.');
                return;
            }

            const novoGasto = { data, descricao, categoria, valor };
            dados.gastos.push(novoGasto);
            
            alert('Gasto adicionado! (Simula√ß√£o)');
            atualizarDashboard();
            montarTabelaGastos(dados.gastos, 'tabelaGastos');
            // Aqui voc√™ enviaria para a API
        }

        function adicionarBoleto() {
            const descricao = document.getElementById('boletoDescricao').value;
            const valor = parseFloat(document.getElementById('boletoValor').value);
            const vencimento = document.getElementById('boletoVencimento').value;

            if (!descricao || !vencimento || isNaN(valor) || valor <= 0) {
                alert('Preencha todos os campos corretamente para registrar o boleto.');
                return;
            }

            const novoId = Math.max(0, ...dados.boletos.map(b => b.id)) + 1;
            const novoBoleto = { id: novoId, descricao, valor, vencimento, status: 'Pendente', dataPagamento: '', meioPagamento: '' };
            dados.boletos.push(novoBoleto);

            alert('Boleto adicionado! (Simula√ß√£o)');
            atualizarDashboard();
            montarTabelaBoletos(dados.boletos, 'tabelaBoletos');
            // Aqui voc√™ enviaria para a API
        }

        function adicionarEPI() {
            const item = document.getElementById('epiItem').value;
            const categoria = document.getElementById('epiCategoria').value;
            const quantidade = parseInt(document.getElementById('epiQuantidade').value);
            const minimo = parseInt(document.getElementById('epiMinimo').value);
            const hoje = new Date().toISOString().split('T')[0];

            if (!item || !categoria || isNaN(quantidade) || quantidade < 0 || isNaN(minimo) || minimo < 0) {
                alert('Preencha todos os campos corretamente para registrar o EPI.');
                return;
            }

            const novoId = Math.max(0, ...dados.estoque.map(e => e.id)) + 1;
            const novoEPI = { id: novoId, item, categoria, quantidade, minimo, dataUltimaEntrada: hoje, dataUltimaSaida: '' };
            dados.estoque.push(novoEPI);

            alert('EPI adicionado! (Simula√ß√£o)');
            atualizarDashboard();
            montarTabelaEstoque(dados.estoque, 'tabelaEstoque');
            // Aqui voc√™ enviaria para a API
        }

        function adicionarMaterial() {
            const data = document.getElementById('materialData').value;
            const item = document.getElementById('materialItem').value;
            const quantidade = parseInt(document.getElementById('materialQuantidade').value);
            const valor = parseFloat(document.getElementById('materialValor').value);
            const fornecedor = document.getElementById('materialFornecedor').value;

            if (!data || !item || !fornecedor || isNaN(quantidade) || quantidade <= 0 || isNaN(valor) || valor <= 0) {
                alert('Preencha todos os campos corretamente para registrar a compra de material.');
                return;
            }

            const novoMaterial = { data, item, quantidade, valor, fornecedor };
            dados.materiais.push(novoMaterial);

            alert('Material adicionado! (Simula√ß√£o)');
            atualizarDashboard();
            montarTabelaMateriais(dados.materiais, 'tabelaMateriais');
            // Aqui voc√™ enviaria para a API
        }

        // Fun√ß√µes auxiliares para Relat√≥rios
        function filtrarDadosPorData(lista, campoData, inicio, fim) {
            if (!inicio || !fim) return lista;
            const dataInicio = new Date(inicio + 'T00:00:00');
            const dataFim = new Date(fim + 'T23:59:59');

            return lista.filter(item => {
                const dataItem = new Date(item[campoData]);
                return dataItem >= dataInicio && dataItem <= dataFim;
            });
        }

        // --- MODIFICA√á√ÉO RELAT√ìRIO: Chamando as tabelas com os novos campos ---
        function gerarRelatorio() {
            const inicio = document.getElementById('relatorioDataInicio').value;
            const fim = document.getElementById('relatorioDataFim').value;
            const output = document.getElementById('relatorioOutput');
            
            if ((!inicio || !fim) && (document.getElementById('checkGastos').checked || document.getElementById('checkMateriais').checked)) {
                alert('Por favor, defina as Datas Inicial e Final para relat√≥rios de Gastos e Materiais.');
                return;
            }

            let htmlRelatorio = `<h1 style="color: #667eea; margin-bottom: 20px;">Relat√≥rio Gerencial</h1>
                                <p style="margin-bottom: 20px;"><strong>Per√≠odo:</strong> ${inicio ? formatarData(inicio) + ' a ' + formatarData(fim) : 'Completo'}</p>`;
            
            // Filtra os dados
            const gastosFiltrados = filtrarDadosPorData(dados.gastos, 'data', inicio, fim);
            const boletosFiltrados = dados.boletos;
            const estoqueFiltrado = dados.estoque; 
            const materiaisFiltrados = filtrarDadosPorData(dados.materiais, 'data', inicio, fim);

            // Adiciona o conte√∫do selecionado
            if (document.getElementById('checkResumo').checked) {
                const totalGastos = gastosFiltrados.reduce((sum, g) => sum + parseFloat(g.valor), 0);
                const totalBoletosP = boletosFiltrados.filter(b => b.status !== 'Pago').reduce((sum, b) => sum + parseFloat(b.valor), 0);
                
                htmlRelatorio += `
                    <div class="cards-grid">
                        <div class="card"><div class="card-title">Total Gasto no Per√≠odo</div><div class="card-value">${formatarMoeda(totalGastos)}</div></div>
                        <div class="card danger"><div class="card-title">Total Boletos Pendentes</div><div class="card-value">${formatarMoeda(totalBoletosP)}</div></div>
                        <div class="card success"><div class="card-title">Itens Estoque Baixo</div><div class="card-value">${estoqueFiltrado.filter(e => parseInt(e.quantidade) < parseInt(e.minimo)).length}</div></div>
                    </div>
                    <h2 style="margin-top: 30px; color: #667eea;">Detalhes do Relat√≥rio</h2>
                `;
            }

            if (document.getElementById('checkGastos').checked) {
                htmlRelatorio += `<h3 style="margin-top: 20px; color: #333;">Gastos Di√°rios (${gastosFiltrados.length} Registros)</h3>`;
                htmlRelatorio += gerarTabelaHTML(gastosFiltrados, 
                    ['Data', 'Descri√ß√£o', 'Categoria', 'Valor'], 
                    ['data', 'descricao', 'categoria', 'valor'], 
                    'valor', 
                    'Total Gasto',
                    { formatarData: ['data'], formatarMoeda: ['valor'] }
                );
            }
            
            if (document.getElementById('checkBoletos').checked) {
                htmlRelatorio += `<h3 style="margin-top: 20px; color: #333;">Controle de Boletos (${boletosFiltrados.length} Registros)</h3>`;
                htmlRelatorio += gerarTabelaHTML(boletosFiltrados, 
                    ['Descri√ß√£o', 'Valor', 'Vencimento', 'Status', 'Data Pag.', 'Meio Pag.'], 
                    ['descricao', 'valor', 'vencimento', 'status', 'dataPagamento', 'meioPagamento'], 
                    'valor', 
                    'Total Pendente',
                    { formatarData: ['vencimento', 'dataPagamento'], totalFiltrado: (b) => b.status !== 'Pago' }
                );
            }
            
            if (document.getElementById('checkEstoque').checked) {
                htmlRelatorio += `<h3 style="margin-top: 20px; color: #333;">Estoque de EPIs (${estoqueFiltrado.length} Itens)</h3>`;
                htmlRelatorio += gerarTabelaHTML(estoqueFiltrado, 
                    ['Item', 'Categoria', 'Quantidade', 'M√≠nimo', 'Status', '√öltima Entrada', '√öltima Sa√≠da'], 
                    ['item', 'categoria', 'quantidade', 'minimo', (e) => parseInt(e.quantidade) < parseInt(e.minimo) ? 'Baixo' : 'OK', 'dataUltimaEntrada', 'dataUltimaSaida'], 
                    null, 
                    'Itens Baixo Estoque',
                    { formatarData: ['dataUltimaEntrada', 'dataUltimaSaida'], totalPersonalizado: estoqueFiltrado.filter(e => parseInt(e.quantidade) < parseInt(e.minimo)).length, totalNaUltimaColuna: true }
                );
            }
            
            if (document.getElementById('checkMateriais').checked) {
                htmlRelatorio += `<h3 style="margin-top: 20px; color: #333;">Compra de Materiais (${materiaisFiltrados.length} Registros)</h3>`;
                htmlRelatorio += gerarTabelaHTML(materiaisFiltrados, 
                    ['Data', 'Item', 'Quantidade', 'Valor Total', 'Fornecedor'], 
                    ['data', 'item', 'quantidade', 'valor', 'fornecedor'], 
                    'valor', 
                    'Total Gasto',
                    { formatarData: ['data'], formatarMoeda: ['valor'] }
                );
            }

            output.innerHTML = htmlRelatorio;
            output.style.display = 'block';
            document.querySelector('.print-button').style.display = 'inline-block';
        }

        function gerarTabelaHTML(data, headers, keys, totalKey, totalLabel, formatOptions = {}) {
            let html = '<table><thead><tr>';
            headers.forEach(h => html += `<th>${h}</th>`);
            html += '</tr></thead><tbody>';

            let totalCalculado = 0;
            
            data.forEach(item => {
                html += '<tr>';
                keys.forEach(keyOrFunc => {
                    let value;
                    let key = typeof keyOrFunc === 'function' ? null : keyOrFunc;

                    if (typeof keyOrFunc === 'function') {
                        value = keyOrFunc(item);
                    } else {
                        value = item[keyOrFunc];
                    }

                    // Formata√ß√£o de Moeda
                    if (formatOptions.formatarMoeda && key && formatOptions.formatarMoeda.includes(key)) {
                        value = formatarMoeda(value);
                    } 
                    // Formata√ß√£o de Data
                    else if (formatOptions.formatarData && key && formatOptions.formatarData.includes(key)) {
                        value = formatarData(value);
                    }

                    html += `<td>${value || 'N/A'}</td>`;
                });
                html += '</tr>';
                
                // C√°lculo do Total
                if (totalKey && item[totalKey]) {
                    let deveSomar = true;
                    if (formatOptions.totalFiltrado) {
                        deveSomar = formatOptions.totalFiltrado(item);
                    }
                    if (deveSomar) {
                        totalCalculado += parseFloat(item[totalKey]);
                    }
                }
            });

            html += '</tbody>';

            if (totalKey || formatOptions.totalPersonalizado !== undefined) {
                const totalIsNumeric = totalKey !== null;
                const totalValue = totalIsNumeric ? formatarMoeda(totalCalculado) : formatOptions.totalPersonalizado;
                
                // Encontra a coluna de valor ou assume a √∫ltima para totais n√£o monet√°rios
                let totalColumnIndex = headers.length - 1; 
                if (totalKey) {
                    const valueHeaderIndex = headers.findIndex(h => h.includes('Valor') || h.includes('Total'));
                    if (valueHeaderIndex !== -1) totalColumnIndex = valueHeaderIndex;
                } else if (!formatOptions.totalNaUltimaColuna) {
                    // Se for um total n√£o monet√°rio mas n√£o quiser na √∫ltima coluna, desconsidera
                    totalColumnIndex = -1;
                }
                
                if (totalColumnIndex !== -1) {
                    const colSpan = totalColumnIndex;
                    const valueColSpan = headers.length - totalColumnIndex; 

                    html += `<tfoot><tr><td colspan="${colSpan + 1}">${totalLabel}</td>`;
                    
                    // Preenche as c√©lulas vazias antes da c√©lula do total
                    for(let i = 0; i < valueColSpan - 1; i++) {
                        html += '<td></td>';
                    }
                    
                    // C√©lula do total (que pode ter colspan 1)
                    html += `<td colspan="${valueColSpan - (valueColSpan > 1 ? 1 : 0)}">${totalValue}</td>`;
                    
                    html += `</tr></tfoot>`;
                } else if (totalKey) {
                    // Fallback para total monet√°rio na √∫ltima coluna se n√£o achou "Valor"
                     html += `<tfoot><tr><td colspan="${headers.length - 1}">${totalLabel}</td><td>${totalValue}</td></tr></tfoot>`;
                }
            }


            html += '</table>';
            return `<div class="data-table" style="box-shadow: none; padding: 15px 0;">${html}</div>`;
        }

        function inicializarFiltrosRelatorio() {
            const hoje = new Date().toISOString().split('T')[0];
            const primeiroDiaMes = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('relatorioDataInicio').value = primeiroDiaMes;
            document.getElementById('relatorioDataFim').value = hoje;
        }


        // Inicia o carregamento dos dados
        document.addEventListener('DOMContentLoaded', () => {
            carregarDados();
            mudarAba('dashboard'); // Garante que a aba Dashboard esteja ativa ao iniciar
        });
    </script>
</body>
</html>
