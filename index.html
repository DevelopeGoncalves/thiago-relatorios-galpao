<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o Empresarial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .config-section h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        /* Ajuste para inputs em grupos verticais (filtros de relat√≥rio) */
        .input-group > div {
            flex-grow: 1;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"] {
            flex: 1;
            min-width: 250px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }
        
        .btn-action {
            padding: 8px 15px;
            margin-right: 5px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .btn-danger {
            background: #f03e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #e03131;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 25px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-title {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .card-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .card.danger .card-value {
            color: #f03e3e;
        }

        .card.success .card-value {
            color: #51cf66;
        }

        .data-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky; /* Sticky header para tabelas longas */
            top: 0;
        }
        
        tfoot td {
            font-weight: bold;
            border-top: 2px solid #667eea;
            background: #f0f4ff; /* Fundo leve para o rodap√© */
        }


        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-vencido {
            background: #ffe0e0;
            color: #f03e3e;
        }
        
        .status-pago {
            background: #d3f9d8;
            color: #2b8a3e;
        }

        .status-proximo {
            background: #fff3cd;
            color: #fd7e14;
        }

        .status-ok {
            background: #d3f9d8;
            color: #2b8a3e;
        }
        
        .status-baixo {
            background: #ffe0e0;
            color: #f03e3e;
        }

        .form-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        /* 1. Aba "Adicionar" Reorganizada (GRID) */
        .form-section.add-forms .form-grid {
            display: grid;
            /* Divide em colunas de tamanho flex√≠vel, ajusta para 1 coluna em telas pequenas */
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-section.add-forms h3 {
            grid-column: 1 / -1; /* T√≠tulo ocupa toda a largura */
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            margin-top: 20px;
        }

        .form-section.add-forms h3:first-child {
            border-top: none;
            margin-top: 0;
        }

        .form-section.add-forms .btn-success {
            /* O bot√£o de adicionar fica na linha ap√≥s os campos */
            grid-column: 1 / -1; 
            margin-top: 10px;
            justify-self: start;
        }
        
        /* 2. & 3. Otimiza√ß√£o para Impress√£o */
        @media print {
            /* 1. Remove elementos desnecess√°rios (menus, filtros) */
            body > .container > header,
            body > .container > .tabs,
            .report-controls,
            .btn-action,
            .print-button,
            /* Remove tudo que n√£o for o container principal do relat√≥rio */
            #dashboard,
            #gastos,
            #boletos,
            #estoque,
            #materiais,
            #graficos,
            #adicionar {
                display: none !important;
            }

            /* 2. Mant√©m apenas a sa√≠da do relat√≥rio vis√≠vel */
            .tab-content {
                display: block !important;
            }
            
            #relatorioOutput {
                display: block !important; /* Garante que o conte√∫do gerado seja impresso */
                box-shadow: none !important; /* Remove sombra para impress√£o limpa */
                padding: 0 !important;
                margin-top: 0 !important;
            }
            
            body {
                background: white !important;
                padding: 0;
            }

            .container {
                max-width: none !important;
                margin: 0;
            }
            
            /* 3. Evita quebras de p√°gina no meio das tabelas (tfoot √© importante para totais) */
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            /* Remove fundos de cabe√ßalho para economia de tinta, mantendo a cor do texto */
            th {
                background: #f0f0f0 !important;
                color: #333 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            /* Garante que os badges coloridos sejam impressos (se for o caso) */
            .status-badge {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Sistema de Gest√£o Empresarial</h1>
            <p>Dashboard completo de controle financeiro e estoque</p>
            
            <div class="config-section">
                <h3>üîó Configura√ß√£o do Google Sheets (Via Apps Script)</h3>
                <div class="input-group">
                    <input type="text" id="sheetId" placeholder="ID da Planilha do Google Sheets">
                    <button class="btn-primary" onclick="salvarConfiguracao()">Salvar Configura√ß√£o</button>
                    <button class="btn-success" onclick="carregarDados()">Atualizar Dados</button>
                </div>
                <small style="color: #666;">A URL da API Web est√° fixa no c√≥digo, use este campo apenas para guardar o ID da planilha.</small>
            </div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="mudarAba('dashboard')">Dashboard</button>
            <button class="tab" onclick="mudarAba('gastos')">Gastos Di√°rios</button>
            <button class="tab" onclick="mudarAba('boletos')">Boletos</button>
            <button class="tab" onclick="mudarAba('estoque')">Estoque EPI</button>
            <button class="tab" onclick="mudarAba('materiais')">Materiais</button>
            <button class="tab" onclick="mudarAba('graficos')">üìä Gr√°ficos</button>
            <button class="tab" onclick="mudarAba('adicionar')">Adicionar</button>
            <button class="tab" onclick="mudarAba('relatorios')">üìÑ Relat√≥rios</button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="cards-grid">
                <div class="card">
                    <div class="card-title">Gastos Hoje</div>
                    <div class="card-value" id="gastosHoje">R$ 0,00</div>
                </div>
                <div class="card">
                    <div class="card-title">Gastos M√™s</div>
                    <div class="card-value" id="gastosMes">R$ 0,00</div>
                </div>
                <div class="card danger">
                    <div class="card-title">Boletos Vencidos</div>
                    <div class="card-value" id="boletosVencidos">0</div>
                </div>
                <div class="card success">
                    <div class="card-title">EPIs em Estoque</div>
                    <div class="card-value" id="episEstoque">0</div>
                </div>
            </div>

            <div class="data-table">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìÖ Pr√≥ximos Vencimentos</h2>
                <div id="proximosVencimentos"></div>
            </div>
        </div>

        <div id="gastos" class="tab-content">
            <div class="data-table">
                <h2 style="margin-bottom: 20px; color: #667eea;">üí∞ Gastos Di√°rios</h2>
                <div id="tabelaGastos"></div>
            </div>
        </div>

        <div id="boletos" class="tab-content">
            <div class="data-table">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìÑ Controle de Boletos</h2>
                <div id="tabelaBoletos"></div>
            </div>
        </div>

        <div id="estoque" class="tab-content">
            <div class="data-table">
                <h2 style="margin-bottom: 20px; color: #667eea;">ü¶∫ Estoque de EPIs</h2>
                <div id="tabelaEstoque"></div>
            </div>
        </div>

        <div id="materiais" class="tab-content">
            <div class="data-table">
                <h2 style="margin-bottom: 20px; color: #667eea;">üõ†Ô∏è Compra de Materiais</h2>
                <div id="tabelaMateriais"></div>
            </div>
        </div>

        <div id="graficos" class="tab-content">
            <div class="chart-container">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìä Gr√°ficos e An√°lises</h2>
                
                <h3 style="margin: 20px 0;">Gastos por Categoria</h3>
                <canvas id="graficoGastos" style="max-height: 300px;"></canvas>
                
                <h3 style="margin: 40px 0 20px 0;">Evolu√ß√£o de Gastos (√öltimos 7 Dias)</h3>
                <canvas id="graficoEvolucao" style="max-height: 300px;"></canvas>
                
                <h3 style="margin: 40px 0 20px 0;">Status do Estoque de EPIs</h3>
                <canvas id="graficoEstoque" style="max-height: 300px;"></canvas>
                
                <h3 style="margin: 40px 0 20px 0;">Boletos por Status</h3>
                <canvas id="graficoBoletos" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <div id="adicionar" class="tab-content">
            <div class="form-section add-forms">
                <h2 style="margin-bottom: 20px; color: #667eea;">‚ûï Adicionar Novos Registros</h2>
                
                <h3>üí∞ Adicionar Gasto</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Data:</label>
                        <input type="date" id="gastoData">
                    </div>
                    <div class="form-group">
                        <label>Descri√ß√£o:</label>
                        <input type="text" id="gastoDescricao" placeholder="Ex: Combust√≠vel">
                    </div>
                    <div class="form-group">
                        <label>Categoria:</label>
                        <input type="text" id="gastoCategoria" placeholder="Ex: Transporte">
                    </div>
                    <div class="form-group">
                        <label>Valor (R$):</label>
                        <input type="number" id="gastoValor" step="0.01" placeholder="0.00">
                    </div>
                    <button class="btn-success" onclick="adicionarGasto()">Adicionar Gasto</button>
                </div>

                <h3>üìÑ Adicionar Boleto</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Descri√ß√£o:</label>
                        <input type="text" id="boletoDescricao" placeholder="Ex: Energia El√©trica">
                    </div>
                    <div class="form-group">
                        <label>Valor (R$):</label>
                        <input type="number" id="boletoValor" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Data de Vencimento:</label>
                        <input type="date" id="boletoVencimento">
                    </div>
                    <button class="btn-success" onclick="adicionarBoleto()">Adicionar Boleto</button>
                </div>

                <h3>ü¶∫ Adicionar Item ao Estoque EPI</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome do Item:</label>
                        <input type="text" id="epiItem" placeholder="Ex: Capacete de Seguran√ßa">
                    </div>
                    <div class="form-group">
                        <label>Quantidade:</label>
                        <input type="number" id="epiQuantidade" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Quantidade M√≠nima:</label>
                        <input type="number" id="epiMinimo" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Categoria:</label>
                        <input type="text" id="epiCategoria" placeholder="Ex: Prote√ß√£o">
                    </div>
                    <button class="btn-success" onclick="adicionarEPI()">Adicionar ao Estoque</button>
                </div>

                <h3>üõ†Ô∏è Adicionar Compra de Material</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Data da Compra:</label>
                        <input type="date" id="materialData">
                    </div>
                    <div class="form-group">
                        <label>Item:</label>
                        <input type="text" id="materialItem" placeholder="Ex: Cimento">
                    </div>
                    <div class="form-group">
                        <label>Quantidade:</label>
                        <input type="number" id="materialQuantidade" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Valor Total (R$):</label>
                        <input type="number" id="materialValor" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Fornecedor:</label>
                        <input type="text" id="materialFornecedor" placeholder="Ex: Constrular">
                    </div>
                    <button class="btn-success" onclick="adicionarMaterial()">Adicionar Material</button>
                </div>
            </div>
        </div>
        
        <div id="relatorios" class="tab-content">
            <div class="form-section report-controls">
                <h2 style="margin-bottom: 20px; color: #667eea;">üìÑ Configura√ß√£o do Relat√≥rio</h2>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <div style="min-width: 250px;">
                        <label>Data Inicial:</label>
                        <input type="date" id="relatorioDataInicio">
                    </div>
                    <div style="min-width: 250px;">
                        <label>Data Final:</label>
                        <input type="date" id="relatorioDataFim">
                    </div>
                </div>
                
                <h3 style="margin-top: 15px; margin-bottom: 10px;">Conte√∫do:</h3>
                <div class="input-group" style="gap: 20px;">
                    <label><input type="checkbox" id="checkResumo" checked> Resumo Geral</label>
                    <label><input type="checkbox" id="checkGastos" checked> Gastos Di√°rios</label>
                    <label><input type="checkbox" id="checkBoletos" checked> Boletos</label>
                    <label><input type="checkbox" id="checkEstoque" checked> Estoque EPI</label>
                    <label><input type="checkbox" id="checkMateriais" checked> Materiais</label>
                </div>
                
                <div class="input-group" style="margin-top: 20px;">
                    <button class="btn-primary" onclick="gerarRelatorio()">üìä Gerar Relat√≥rio</button>
                    <button class="btn-success print-button" onclick="window.print()" style="display: none;">üñ®Ô∏è Imprimir Relat√≥rio</button>
                </div>
            </div>

            <div id="relatorioOutput" class="data-table" style="margin-top: 30px; display: none;">
                </div>
        </div>
    </div>

    <script>
        // URL da API WEB do Google Apps Script (Corrigida e Fixa)
        const webAppUrl = "https://script.google.com/macros/s/AKfycbyGYfUdoyPExuRrnTds6ZbwLNpc13K8bsgPh4K-ME2zWUmomC8j45TjvwnRsGKRF_pM/exec";

        let dados = {
            gastos: [],
            boletos: [],
            estoque: [],
            materiais: []
        };
        
        let chartInstances = {};

        function carregarDadosExemplo() {
            // Dados de Exemplo (Usados em caso de falha na API ou na primeira carga)
            const hoje = new Date().toISOString().split('T')[0];
            const dataProximo = new Date();
            dataProximo.setDate(dataProximo.getDate() + 3);
            const dataProximoStr = dataProximo.toISOString().split('T')[0];
            const dataVencido = new Date();
            dataVencido.setDate(dataVencido.getDate() - 5);
            const dataVencidoStr = dataVencido.toISOString().split('T')[0];
            
            dados = {
                gastos: [
                    { data: hoje, descricao: 'Combust√≠vel', valor: 250.00, categoria: 'Transporte' },
                    { data: hoje, descricao: 'Almo√ßo equipe', valor: 120.00, categoria: 'Alimenta√ß√£o' },
                    { data: '2025-11-22', descricao: 'Material escrit√≥rio', valor: 85.50, categoria: 'Escrit√≥rio' },
                    { data: '2025-11-20', descricao: 'Ped√°gio', valor: 40.00, categoria: 'Transporte' },
                    { data: '2025-11-18', descricao: 'Reparo m√°quina', valor: 550.00, categoria: 'Manuten√ß√£o' },
                    { data: '2025-11-15', descricao: 'Caf√© da manh√£', valor: 50.00, categoria: 'Alimenta√ß√£o' }
                ],
                boletos: [
                    { id: 1, descricao: 'Energia El√©trica', valor: 450.00, vencimento: dataProximoStr, status: 'Pendente' },
                    { id: 2, descricao: '√Ågua', valor: 120.00, vencimento: dataVencidoStr, status: 'Pendente' },
                    { id: 3, descricao: 'Internet', valor: 199.90, vencimento: '2025-12-05', status: 'Pendente' },
                    { id: 4, descricao: 'Aluguel', valor: 2500.00, vencimento: '2025-10-01', status: 'Pago' }
                ],
                estoque: [
                    { id: 1, item: 'Capacete', quantidade: 45, minimo: 20, categoria: 'Prote√ß√£o' },
                    { id: 2, item: 'Luva', quantidade: 120, minimo: 50, categoria: 'Prote√ß√£o' },
                    { id: 3, item: '√ìculos de Prote√ß√£o', quantidade: 15, minimo: 30, categoria: 'Prote√ß√£o' }
                ],
                materiais: [
                    { data: '2025-11-20', item: 'Cimento', quantidade: 50, valor: 1500.00, fornecedor: 'Constrular' },
                    { data: '2025-11-18', item: 'Areia', quantidade: 100, valor: 800.00, fornecedor: 'Arei√£o' }
                ]
            };
            
            dados.boletos.forEach((b, i) => b.id = b.id || (i + 1));
            dados.estoque.forEach((e, i) => e.id = e.id || (i + 1));

            // Garante que o dashboard seja atualizado
            atualizarDashboard();
        }

        function carregarDados() {
            if (!webAppUrl) {
                alert('A URL da sua API Web do Google Apps Script n√£o est√° configurada!');
                return carregarDadosExemplo(); 
            }

            // Requisi√ß√£o Fetch para buscar os dados na API Web
            fetch(webAppUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro de rede: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        alert('Erro na API Apps Script: ' + data.error);
                        return;
                    }
                    
                    // As chaves do objeto 'data' devem ser min√∫sculas e corresponder √†s abas
                    dados.gastos = data.gastos || [];
                    dados.boletos = data.boletos || [];
                    dados.estoque = data.estoque || [];
                    dados.materiais = data.materiais || [];

                    alert('Dados atualizados com sucesso do Google Sheets! (Via Apps Script)');
                    atualizarDashboard();
                    
                    // Se estiver na aba gr√°ficos ou relat√≥rios, atualiza o conte√∫do
                    const abaAtiva = document.querySelector('.tab-content.active').id;
                    if (abaAtiva === 'graficos') atualizarGraficos();
                    if (abaAtiva === 'relatorios') gerarRelatorio();
                })
                .catch(error => {
                    console.error('Falha ao carregar dados:', error);
                    alert(`Falha ao conectar com a API Web. Carregando dados de exemplo. Detalhes: ${error.message}. Verifique se a planilha est√° p√∫blica e a URL est√° correta.`);
                    carregarDadosExemplo(); 
                });
        }

        function salvarConfiguracao() {
            const sheetId = document.getElementById('sheetId').value;
            // Apenas para armazenar o ID da planilha no localStorage, caso o usu√°rio queira us√°-lo depois
            if (sheetId) {
                localStorage.setItem('googleSheetId', sheetId);
            }
            alert('Configura√ß√£o salva! Clique em "Atualizar Dados" para carregar informa√ß√µes da API Web.');
        }


        // Mant√©m a fun√ß√£o original mudarAba e adiciona a l√≥gica de inicializa√ß√£o
        function mudarAba(aba) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            const target = event ? event.target : document.querySelector(`.tab[onclick*="${aba}"]`);
            if (target) target.classList.add('active');
            document.getElementById(aba).classList.add('active');
            
            atualizarDashboard();

            if (aba === 'graficos') {
                atualizarGraficos(); // Renderiza gr√°ficos apenas quando a aba √© ativada
            } else if (aba === 'relatorios') {
                inicializarFiltrosRelatorio();
                document.getElementById('relatorioOutput').style.display = 'none'; // Esconde a sa√≠da ao entrar
                document.querySelector('.print-button').style.display = 'none'; // Esconde o bot√£o Imprimir
            }
        }

        function formatarMoeda(valor) {
            // Converte para float antes de formatar, garantindo que o valor seja tratado corretamente
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(parseFloat(valor) || 0);
        }

        function calcularDiasAteVencimento(dataVencimento) {
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); // Zera hora para c√°lculo correto de dias
            const vencimento = new Date(dataVencimento);
            vencimento.setHours(0, 0, 0, 0);
            const diff = Math.ceil((vencimento.getTime() - hoje.getTime()) / (1000 * 60 * 60 * 24));
            return diff;
        }

        function getStatusBoleto(dataVencimento, statusAtual) {
            if (statusAtual === 'Pago') return { classe: 'status-pago', texto: 'Pago' };

            const dias = calcularDiasAteVencimento(dataVencimento);
            if (dias < 0) return { classe: 'status-vencido', texto: 'Vencido' };
            if (dias <= 7) return { classe: 'status-proximo', texto: `${dias} dias` };
            return { classe: 'status-ok', texto: 'Pendente' };
        }
        
        function marcarBoletoPago(id) {
            const boleto = dados.boletos.find(b => b.id === id);
            if (boleto) {
                if (boleto.status === 'Pago') {
                    alert('Boleto j√° est√° marcado como Pago.');
                    return;
                }
                // Em um sistema real, aqui voc√™ faria uma chamada POST/PUT para o Apps Script
                boleto.status = 'Pago';
                alert(`Boleto ${boleto.descricao} marcado como Pago! (Simula√ß√£o)`);
                atualizarDashboard();
                atualizarGraficos();
            }
        }
        
        function entradaEstoque(id) {
            const item = dados.estoque.find(e => e.id === id);
            if (item) {
                const quantidade = parseInt(prompt(`Quantas unidades de ${item.item} est√£o entrando no estoque?`));
                if (isNaN(quantidade) || quantidade <= 0) {
                    alert('Entrada inv√°lida.');
                    return;
                }
                // Em um sistema real, voc√™ faria uma chamada para atualizar o Apps Script
                item.quantidade = parseInt(item.quantidade) + quantidade;
                alert(`${quantidade} unidades de ${item.item} adicionadas! Novo total: ${item.quantidade}. (Simula√ß√£o)`);
                atualizarDashboard();
                atualizarGraficos();
            }
        }
        
        function saidaEstoque(id) {
            const item = dados.estoque.find(e => e.id === id);
            if (item) {
                const quantidade = parseInt(prompt(`Quantas unidades de ${item.item} est√£o saindo do estoque?`));
                if (isNaN(quantidade) || quantidade <= 0) {
                    alert('Sa√≠da inv√°lida.');
                    return;
                }
                if (item.quantidade < quantidade) {
                    alert('Quantidade em estoque insuficiente.');
                    return;
                }
                // Em um sistema real, voc√™ faria uma chamada para atualizar o Apps Script
                item.quantidade = parseInt(item.quantidade) - quantidade;
                alert(`${quantidade} unidades de ${item.item} removidas! Novo total: ${item.quantidade}. (Simula√ß√£o)`);
                atualizarDashboard();
                atualizarGraficos();
            }
        }

        function atualizarDashboard() {
            // GASTOS
            const hoje = new Date().toISOString().split('T')[0];
            const mesAtual = new Date().getMonth();

            const gastosHoje = dados.gastos
                .filter(g => g.data === hoje)
                .reduce((sum, g) => sum + parseFloat(g.valor), 0);
            document.getElementById('gastosHoje').textContent = formatarMoeda(gastosHoje);

            const gastosMes = dados.gastos
                .filter(g => new Date(g.data).getMonth() === mesAtual)
                .reduce((sum, g) => sum + parseFloat(g.valor), 0);
            document.getElementById('gastosMes').textContent = formatarMoeda(gastosMes);

            // BOLETOS
            const boletosVencidos = dados.boletos.filter(b => b.status !== 'Pago' && calcularDiasAteVencimento(b.vencimento) < 0).length;
            document.getElementById('boletosVencidos').textContent = boletosVencidos;

            const proximosBoletos = dados.boletos
                .filter(b => b.status !== 'Pago')
                .sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento))
                .slice(0, 5);

            let htmlVencimentos = '<table><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Vencimento</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>';
            proximosBoletos.forEach(b => {
                const status = getStatusBoleto(b.vencimento, b.status);
                htmlVencimentos += `
                    <tr>
                        <td>${b.descricao}</td>
                        <td>${formatarMoeda(b.valor)}</td>
                        <td>${new Date(b.vencimento).toLocaleDateString('pt-BR')}</td>
                        <td><span class="status-badge ${status.classe}">${status.texto}</span></td>
                        <td>${b.status !== 'Pago' ? `<button class="btn-success btn-action" onclick="marcarBoletoPago(${b.id})">Pagar</button>` : ''}</td>
                    </tr>
                `;
            });
            htmlVencimentos += '</tbody></table>';
            document.getElementById('proximosVencimentos').innerHTML = htmlVencimentos;

            // ESTOQUE
            const totalEPIs = dados.estoque.reduce((sum, e) => sum + parseInt(e.quantidade), 0);
            document.getElementById('episEstoque').textContent = totalEPIs;

            // TABELAS (A√ß√µes de Excluir/Entrada/Sa√≠da s√≥ aparecem aqui)
            let htmlGastos = gerarTabelaGastos(dados.gastos.sort((a, b) => new Date(b.data) - new Date(a.data)), true);
            document.getElementById('tabelaGastos').innerHTML = htmlGastos;

            let htmlBoletos = gerarTabelaBoletos(dados.boletos, true);
            document.getElementById('tabelaBoletos').innerHTML = htmlBoletos;

            let htmlEstoque = gerarTabelaEstoque(dados.estoque, true);
            document.getElementById('tabelaEstoque').innerHTML = htmlEstoque;

            let htmlMateriais = gerarTabelaMateriais(dados.materiais.sort((a, b) => new Date(b.data) - new Date(a.data)), true);
            document.getElementById('tabelaMateriais').innerHTML = htmlMateriais;
        }
        
        // --- GR√ÅFICOS (CHART.JS) ---

        function destruirGrafico(id) {
            if (chartInstances[id]) {
                chartInstances[id].destroy();
                delete chartInstances[id];
            }
        }

        function atualizarGraficos() {
            destruirGrafico('graficoGastos');
            destruirGrafico('graficoEvolucao');
            destruirGrafico('graficoEstoque');
            destruirGrafico('graficoBoletos');

            // 1. Gastos por Categoria (Pie Chart)
            const gastosPorCategoria = dados.gastos.reduce((acc, g) => {
                acc[g.categoria] = (acc[g.categoria] || 0) + parseFloat(g.valor);
                return acc;
            }, {});

            const categorias = Object.keys(gastosPorCategoria);
            const valores = Object.values(gastosPorCategoria);
            
            const backgroundColors = categorias.map((_, i) => `hsl(${i * 60}, 70%, 50%)`);

            chartInstances['graficoGastos'] = new Chart(document.getElementById('graficoGastos'), {
                type: 'pie',
                data: {
                    labels: categorias,
                    datasets: [{
                        data: valores,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });

            // 2. Evolu√ß√£o de Gastos (√öltimos 7 Dias) (Line Chart)
            const gastos7Dias = {};
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);

            for (let i = 6; i >= 0; i--) {
                const data = new Date(hoje);
                data.setDate(hoje.getDate() - i);
                const dataStr = data.toISOString().split('T')[0];
                gastos7Dias[dataStr] = 0;
            }

            dados.gastos.forEach(g => {
                if (g.data in gastos7Dias) {
                    gastos7Dias[g.data] += parseFloat(g.valor);
                }
            });

            const labelsEvolucao = Object.keys(gastos7Dias).map(dateStr => new Date(dateStr).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
            const dataEvolucao = Object.values(gastos7Dias);

            chartInstances['graficoEvolucao'] = new Chart(document.getElementById('graficoEvolucao'), {
                type: 'line',
                data: {
                    labels: labelsEvolucao,
                    datasets: [{
                        label: 'Gasto Di√°rio (R$)',
                        data: dataEvolucao,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
            
            // 3. Status do Estoque de EPIs (Bar Chart)
            const estoqueLabels = dados.estoque.map(e => e.item);
            const estoqueQuantidades = dados.estoque.map(e => parseInt(e.quantidade));
            const estoqueMinimos = dados.estoque.map(e => parseInt(e.minimo));

            chartInstances['graficoEstoque'] = new Chart(document.getElementById('graficoEstoque'), {
                type: 'bar',
                data: {
                    labels: estoqueLabels,
                    datasets: [
                        {
                            label: 'Em Estoque',
                            data: estoqueQuantidades,
                            backgroundColor: '#51cf66'
                        },
                        {
                            label: 'M√≠nimo',
                            data: estoqueMinimos,
                            backgroundColor: '#ffc107'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    scales: { x: { beginAtZero: true } }
                }
            });
            
            // 4. Boletos por Status (Doughnut Chart)
            const boletosStatus = dados.boletos.reduce((acc, b) => {
                const status = getStatusBoleto(b.vencimento, b.status).texto;
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const statusLabels = Object.keys(boletosStatus);
            const statusData = Object.values(boletosStatus);
            
            const statusColors = statusLabels.map(label => {
                if (label === 'Vencido') return '#f03e3e';
                if (label === 'Pago') return '#51cf66';
                if (label.includes('dias')) return '#fd7e14';
                return '#667eea';
            });

            chartInstances['graficoBoletos'] = new Chart(document.getElementById('graficoBoletos'), {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } }
                }
            });
        }
        
        // --- PERSIST√äNCIA E FORMS (SIMULADA) ---
        
        // FUN√á√ïES ADICIONAR REGISTRO (MANTIDAS, mas apenas em mem√≥ria. Em um sistema real, fariam um POST/GET no Apps Script)
        function adicionarRegistro(type, data) {
            switch(type) {
                case 'gasto':
                    data.valor = parseFloat(data.valor);
                    if (data.data && data.descricao && data.valor && data.categoria) {
                        dados.gastos.push(data);
                        alert('Gasto adicionado! (Simula√ß√£o)');
                        document.getElementById('gastoData').value = document.getElementById('gastoDescricao').value = document.getElementById('gastoValor').value = document.getElementById('gastoCategoria').value = '';
                    } else { alert('Preencha todos os campos do Gasto!'); return; }
                    break;
                case 'boleto':
                    data.valor = parseFloat(data.valor);
                    data.id = dados.boletos.length > 0 ? Math.max(...dados.boletos.map(b => b.id)) + 1 : 1;
                    data.status = 'Pendente';
                    if (data.descricao && data.valor && data.vencimento) {
                        dados.boletos.push(data);
                        alert('Boleto adicionado! (Simula√ß√£o)');
                        document.getElementById('boletoDescricao').value = document.getElementById('boletoValor').value = document.getElementById('boletoVencimento').value = '';
                    } else { alert('Preencha todos os campos do Boleto!'); return; }
                    break;
                case 'epi':
                    data.quantidade = parseInt(data.quantidade);
                    data.minimo = parseInt(data.minimo);
                    data.id = dados.estoque.length > 0 ? Math.max(...dados.estoque.map(e => e.id)) + 1 : 1;
                    if (data.item && data.quantidade && data.minimo && data.categoria) {
                        dados.estoque.push(data);
                        alert('Item adicionado ao estoque! (Simula√ß√£o)');
                        document.getElementById('epiItem').value = document.getElementById('epiQuantidade').value = document.getElementById('epiMinimo').value = document.getElementById('epiCategoria').value = '';
                    } else { alert('Preencha todos os campos do EPI!'); return; }
                    break;
                case 'material':
                    data.quantidade = parseInt(data.quantidade);
                    data.valor = parseFloat(data.valor);
                    if (data.data && data.item && data.quantidade && data.valor && data.fornecedor) {
                        dados.materiais.push(data);
                        alert('Compra de material adicionada! (Simula√ß√£o)');
                        document.getElementById('materialData').value = document.getElementById('materialItem').value = document.getElementById('materialQuantidade').value = document.getElementById('materialValor').value = document.getElementById('materialFornecedor').value = '';
                    } else { alert('Preencha todos os campos do Material!'); return; }
                    break;
            }
            atualizarDashboard();
            atualizarGraficos();
        }

        function adicionarGasto() {
            adicionarRegistro('gasto', { 
                data: document.getElementById('gastoData').value, 
                descricao: document.getElementById('gastoDescricao').value, 
                valor: document.getElementById('gastoValor').value, 
                categoria: document.getElementById('gastoCategoria').value 
            });
        }

        function adicionarBoleto() {
            adicionarRegistro('boleto', { 
                descricao: document.getElementById('boletoDescricao').value, 
                valor: document.getElementById('boletoValor').value, 
                vencimento: document.getElementById('boletoVencimento').value 
            });
        }

        function adicionarEPI() {
            adicionarRegistro('epi', { 
                item: document.getElementById('epiItem').value, 
                quantidade: document.getElementById('epiQuantidade').value, 
                minimo: document.getElementById('epiMinimo').value, 
                categoria: document.getElementById('epiCategoria').value 
            });
        }

        function adicionarMaterial() {
            adicionarRegistro('material', { 
                data: document.getElementById('materialData').value, 
                item: document.getElementById('materialItem').value, 
                quantidade: document.getElementById('materialQuantidade').value, 
                valor: document.getElementById('materialValor').value,
                fornecedor: document.getElementById('materialFornecedor').value
            });
        }
        
        // --- FUN√á√ïES DE RELAT√ìRIO E FILTRAGEM ---

        function inicializarFiltrosRelatorio() {
            const dataFim = new Date();
            const dataInicio = new Date();
            dataInicio.setDate(dataFim.getDate() - 30); // Padr√£o: √öltimos 30 dias

            // Formata YYYY-MM-DD
            const formatDate = (date) => date.toISOString().split('T')[0];

            document.getElementById('relatorioDataFim').value = formatDate(dataFim);
            document.getElementById('relatorioDataInicio').value = formatDate(dataInicio);
        }

        function gerarRelatorio() {
            const dataInicioStr = document.getElementById('relatorioDataInicio').value;
            const dataFimStr = document.getElementById('relatorioDataFim').value;
            
            const dataInicio = new Date(dataInicioStr + 'T00:00:00'); 
            const dataFim = new Date(dataFimStr + 'T23:59:59');     

            if (!dataInicioStr || !dataFimStr) {
                alert("Por favor, selecione as datas de in√≠cio e fim.");
                return;
            }
            if (dataInicio > dataFim) {
                alert("A Data Inicial n√£o pode ser maior que a Data Final.");
                return;
            }

            const incluirResumo = document.getElementById('checkResumo').checked;
            const incluirGastos = document.getElementById('checkGastos').checked;
            const incluirBoletos = document.getElementById('checkBoletos').checked;
            const incluirEstoque = document.getElementById('checkEstoque').checked;
            const incluirMateriais = document.getElementById('checkMateriais').checked;

            let relatorioHtml = `<h1 style="color: #667eea; margin-bottom: 10px;">Relat√≥rio de Gest√£o Empresarial</h1>`;
            relatorioHtml += `<p style="margin-bottom: 20px;">Per√≠odo: ${new Date(dataInicioStr).toLocaleDateString('pt-BR')} a ${new Date(dataFimStr).toLocaleDateString('pt-BR')}</p>`;
            relatorioHtml += `<hr style="margin-bottom: 30px; border: 1px solid #eee;">`;

            // 1. Resumo Geral (Cards/Totais)
            if (incluirResumo) {
                const gastosFiltrados = dados.gastos.filter(g => {
                    const dataGasto = new Date(g.data + 'T00:00:00');
                    return dataGasto >= dataInicio && dataGasto <= dataFim;
                });

                const totalGastosPeriodo = gastosFiltrados.reduce((sum, g) => sum + parseFloat(g.valor), 0);
                const boletosVencidos = dados.boletos.filter(b => b.status !== 'Pago' && calcularDiasAteVencimento(b.vencimento) < 0).length;
                const totalEPIs = dados.estoque.reduce((sum, e) => sum + parseInt(e.quantidade), 0);
                
                relatorioHtml += `<h2 style="color: #667eea; margin-bottom: 20px; page-break-after: avoid;">Resumo e Indicadores do Per√≠odo</h2>`;
                relatorioHtml += `
                    <div class="cards-grid" style="margin-bottom: 30px;">
                        <div class="card">
                            <div class="card-title">Gasto Total no Per√≠odo</div>
                            <div class="card-value success">${formatarMoeda(totalGastosPeriodo)}</div>
                        </div>
                        <div class="card danger">
                            <div class="card-title">Boletos Vencidos (Total)</div>
                            <div class="card-value">${boletosVencidos}</div>
                        </div>
                        <div class="card success">
                            <div class="card-title">EPIs em Estoque (Total)</div>
                            <div class="card-value">${totalEPIs}</div>
                        </div>
                        <div class="card">
                            <div class="card-title">Boletos a Pagar (Pendente/Pr√≥ximo)</div>
                            <div class="card-value">${dados.boletos.filter(b => b.status === 'Pendente' && calcularDiasAteVencimento(b.vencimento) >= 0).length}</div>
                        </div>
                    </div>
                `;
            }

            // 2. Gastos Di√°rios
            if (incluirGastos) {
                const gastosFiltrados = dados.gastos.filter(g => {
                    const dataGasto = new Date(g.data + 'T00:00:00');
                    return dataGasto >= dataInicio && dataGasto <= dataFim;
                }).sort((a, b) => new Date(b.data) - new Date(a.data));

                relatorioHtml += `<h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Tabela de Gastos Di√°rios</h2>`;
                relatorioHtml += gerarTabelaGastos(gastosFiltrados, false);
                relatorioHtml += `<div style="page-break-after: always;"></div>`;
            }
            
            // 3. Boletos
            if (incluirBoletos) {
                const boletosFiltrados = dados.boletos.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento)); 
                
                relatorioHtml += `<h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Tabela de Boletos</h2>`;
                relatorioHtml += gerarTabelaBoletos(boletosFiltrados, false);
                relatorioHtml += `<div style="page-break-after: always;"></div>`;
            }

            // 4. Estoque EPI
            if (incluirEstoque) {
                relatorioHtml += `<h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Tabela de Estoque de EPIs</h2>`;
                relatorioHtml += gerarTabelaEstoque(dados.estoque, false);
                relatorioHtml += `<div style="page-break-after: always;"></div>`;
            }
            
            // 5. Materiais
            if (incluirMateriais) {
                const materiaisFiltrados = dados.materiais.filter(m => {
                    const dataMaterial = new Date(m.data + 'T00:00:00');
                    return dataMaterial >= dataInicio && dataMaterial <= dataFim;
                }).sort((a, b) => new Date(b.data) - new Date(a.data));
                
                relatorioHtml += `<h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px;">Tabela de Compra de Materiais</h2>`;
                relatorioHtml += gerarTabelaMateriais(materiaisFiltrados, false);
            }

            document.getElementById('relatorioOutput').innerHTML = relatorioHtml;
            document.getElementById('relatorioOutput').style.display = 'block';
            document.querySelector('.print-button').style.display = 'inline-block';
        }

        // --- FUN√á√ïES DE GERA√á√ÉO DE TABELAS PARA RELAT√ìRIO/DASHBOARD ---

        // Flag 'incluirAcoes' determina se colunas de A√ß√µes e o TFOOT devem ser inclu√≠dos (dashboard sim, relatorio n√£o)
        function gerarTabelaGastos(gastos, incluirAcoes) {
            let html = '<table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th>' + (incluirAcoes ? '<th>A√ß√µes</th>' : '') + '</tr></thead><tbody>';
            let total = 0;
            gastos.forEach(g => {
                total += parseFloat(g.valor);
                const acoes = incluirAcoes ? `<td><button class="btn-danger btn-action" onclick="alert('Excluir Gasto ${g.descricao} - Simulado')">Excluir</button></td>` : '';
                html += `
                    <tr>
                        <td>${new Date(g.data).toLocaleDateString('pt-BR')}</td>
                        <td>${g.descricao}</td>
                        <td>${g.categoria}</td>
                        <td>${formatarMoeda(g.valor)}</td>
                        ${acoes}
                    </tr>
                `;
            });
            html += '</tbody>';
            if (!incluirAcoes) {
                 html += `<tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL DE GASTOS:</td>
                        <td>${formatarMoeda(total)}</td>
                    </tr>
                </tfoot>`;
            }
            html += '</table>';
            return html;
        }

        function gerarTabelaBoletos(boletos, incluirAcoes) {
            let html = '<table><thead><tr><th>Descri√ß√£o</th><th>Valor</th><th>Vencimento</th><th>Status</th>' + (incluirAcoes ? '<th>A√ß√µes</th>' : '') + '</tr></thead><tbody>';
            let totalPendente = 0;
            boletos.forEach(b => {
                const status = getStatusBoleto(b.vencimento, b.status);
                if (b.status !== 'Pago') totalPendente += parseFloat(b.valor);
                
                const acoes = incluirAcoes ? 
                    `<td>${b.status !== 'Pago' ? `<button class="btn-success btn-action" onclick="marcarBoletoPago(${b.id})">Pagar</button>` : ''}</td>` : '';

                html += `
                    <tr>
                        <td>${b.descricao}</td>
                        <td>${formatarMoeda(b.valor)}</td>
                        <td>${new Date(b.vencimento).toLocaleDateString('pt-BR')}</td>
                        <td><span class="status-badge ${status.classe}">${status.texto}</span></td>
                        ${acoes}
                    </tr>
                `;
            });
            html += '</tbody>';
            if (!incluirAcoes) {
                html += `<tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL PENDENTE/VENCIDO:</td>
                        <td colspan="1" style="font-weight: bold;">${formatarMoeda(totalPendente)}</td>
                    </tr>
                </tfoot>`;
            }
            html += '</table>';
            return html;
        }

        function gerarTabelaEstoque(estoque, incluirAcoes) {
            let html = '<table><thead><tr><th>Item</th><th>Quantidade</th><th>M√≠nimo</th><th>Categoria</th><th>Status</th>' + (incluirAcoes ? '<th>A√ß√µes</th>' : '') + '</tr></thead><tbody>';
            estoque.forEach(e => {
                const statusEstoque = parseInt(e.quantidade) < parseInt(e.minimo) ? 'status-baixo' : 'status-ok';
                const textoStatus = parseInt(e.quantidade) < parseInt(e.minimo) ? 'BAIXO' : 'OK';
                
                const acoes = incluirAcoes ? `
                    <td>
                        <button class="btn-primary btn-action" onclick="entradaEstoque(${e.id})">Entrada</button>
                        <button class="btn-danger btn-action" onclick="saidaEstoque(${e.id})">Sa√≠da</button>
                    </td>` : '';
                
                html += `
                    <tr>
                        <td>${e.item}</td>
                        <td>${e.quantidade}</td>
                        <td>${e.minimo}</td>
                        <td>${e.categoria}</td>
                        <td><span class="status-badge ${statusEstoque}">${textoStatus}</span></td>
                        ${acoes}
                    </tr>
                `;
            });
            html += '</tbody></table>';
            return html;
        }

        function gerarTabelaMateriais(materiais, incluirAcoes) {
            let html = '<table><thead><tr><th>Data</th><th>Item</th><th>Quantidade</th><th>Valor Total</th><th>Fornecedor</th>' + (incluirAcoes ? '<th>A√ß√µes</th>' : '') + '</tr></thead><tbody>';
            let total = 0;
            materiais.forEach(m => {
                total += parseFloat(m.valor);
                const acoes = incluirAcoes ? `<td><button class="btn-danger btn-action" onclick="alert('Excluir Compra ${m.item} - Simulado')">Excluir</button></td>` : '';
                html += `
                    <tr>
                        <td>${new Date(m.data).toLocaleDateString('pt-BR')}</td>
                        <td>${m.item}</td>
                        <td>${m.quantidade}</td>
                        <td>${formatarMoeda(m.valor)}</td>
                        <td>${m.fornecedor}</td>
                        ${acoes}
                    </tr>
                `;
            });
            html += '</tbody>';
             if (!incluirAcoes) {
                html += `<tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: bold;">TOTAL COMPRAS:</td>
                        <td colspan="2" style="font-weight: bold;">${formatarMoeda(total)}</td>
                    </tr>
                </tfoot>`;
            }
            html += '</table>';
            return html;
        }
        
        // Inicializa o dashboard e carrega os dados da Web App ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', () => {
             // Tenta carregar dados do Sheets na inicializa√ß√£o
             carregarDados();
             
             // Carrega a configura√ß√£o salva
             const savedSheetId = localStorage.getItem('googleSheetId');
             if (savedSheetId) {
                 document.getElementById('sheetId').value = savedSheetId;
             }
        });
    </script>
</body>
</html>
